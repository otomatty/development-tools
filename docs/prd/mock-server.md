# Mock Server - プロダクト要件定義書 (PRD)

> 最終更新日: 2025 年 11 月 29 日  
> ステータス: Draft  
> バージョン: 1.0.0

## 1. エグゼクティブサマリ

### 1.1 プロダクト概要

Development Tools アプリケーションに組み込まれた**静的ファイル配信サーバー**機能。  
Tauri のサイドカーサービスとして動作し、ローカル開発環境で手軽にファイルサーバーを立ち上げることができる。

### 1.2 開発の背景・目的

| 課題                                                 | 解決策                                 |
| ---------------------------------------------------- | -------------------------------------- |
| ローカル開発時に静的ファイルを配信するサーバーが必要 | ワンクリックでサーバーを起動           |
| 複数のディレクトリから異なるパスで配信したい         | 仮想パスマッピング機能                 |
| CORS 設定が面倒                                      | 簡易モード（全許可）と詳細モードを用意 |
| 配信状況を確認したい                                 | アクセスログをリアルタイム表示         |

### 1.3 ターゲットユーザー

- フロントエンド開発者（API 開発前のモックデータ配信）
- モバイルアプリ開発者（画像・動画ファイルのテスト配信）
- Web デザイナー（ローカルでの静的サイト確認）

---

## 2. 機能要件 (Functional Requirements)

### 2.1 サーバー管理機能

| ID    | 機能           | 説明                                         | 優先度 |
| ----- | -------------- | -------------------------------------------- | ------ |
| FR-01 | サーバー起動   | 手動で Mock サーバーを起動する               | 必須   |
| FR-02 | サーバー停止   | 稼働中の Mock サーバーを停止する             | 必須   |
| FR-03 | ステータス表示 | サーバーの稼働状態（起動中/停止中）を表示    | 必須   |
| FR-04 | ポート設定     | 配信ポート番号を変更可能（デフォルト: 9876） | 必須   |

### 2.2 ディレクトリマッピング機能

| ID    | 機能             | 説明                                                    | 優先度 |
| ----- | ---------------- | ------------------------------------------------------- | ------ |
| FR-05 | 仮想パス追加     | ローカルディレクトリを仮想パスにマッピング              | 必須   |
| FR-06 | 仮想パス編集     | 既存のマッピングを編集                                  | 必須   |
| FR-07 | 仮想パス削除     | マッピングを削除                                        | 必須   |
| FR-08 | ディレクトリ選択 | ネイティブファイルピッカーでディレクトリを選択          | 必須   |
| FR-09 | ファイル一覧表示 | マッピングされたディレクトリ内のファイルを GUI 上で確認 | 必須   |

**マッピング例:**

```
/images    → ~/Pictures/mock/
/api       → ~/projects/mock-api/
/assets    → /var/www/static/
```

### 2.3 CORS 設定機能

| ID    | 機能       | 説明                                       | 優先度 |
| ----- | ---------- | ------------------------------------------ | ------ |
| FR-10 | 簡易モード | 全オリジン許可（`*`）のワンクリック設定    | 必須   |
| FR-11 | 詳細モード | 許可オリジン、メソッド、ヘッダーを個別設定 | 必須   |
| FR-12 | モード切替 | 簡易/詳細モードの切り替え                  | 必須   |

**詳細モード設定項目:**

- `Access-Control-Allow-Origin`: 許可するオリジン（複数指定可）
- `Access-Control-Allow-Methods`: 許可する HTTP メソッド
- `Access-Control-Allow-Headers`: 許可するヘッダー
- `Access-Control-Max-Age`: プリフライトキャッシュ時間

### 2.4 ファイル配信機能

| ID    | 機能             | 説明                                                     | 優先度 |
| ----- | ---------------- | -------------------------------------------------------- | ------ |
| FR-13 | 静的ファイル配信 | マッピングされたディレクトリからファイルを配信           | 必須   |
| FR-14 | MIME 自動判別    | 拡張子に基づいて適切な Content-Type を付与               | 必須   |
| FR-15 | Range リクエスト | 動画のシーク再生に対応（HTTP 206）                       | 必須   |
| FR-16 | インデックス表示 | ディレクトリアクセス時にファイル一覧を表示（オプション） | 中     |

### 2.5 ログ・モニタリング機能

| ID    | 機能             | 説明                                   | 優先度 |
| ----- | ---------------- | -------------------------------------- | ------ |
| FR-17 | アクセスログ表示 | リクエストの履歴をリアルタイムで表示   | 必須   |
| FR-18 | ログフィルタ     | ステータスコード、パスでフィルタリング | 中     |
| FR-19 | ログクリア       | ログ履歴をクリア                       | 必須   |

**ログ表示項目:**

- タイムスタンプ
- HTTP メソッド
- リクエストパス
- ステータスコード
- レスポンスサイズ
- レスポンス時間

### 2.6 設定永続化

| ID    | 機能         | 説明                                          | 優先度 |
| ----- | ------------ | --------------------------------------------- | ------ |
| FR-20 | 設定保存     | ポート、マッピング、CORS 設定を SQLite に保存 | 必須   |
| FR-21 | 設定読み込み | アプリ起動時に前回の設定を復元                | 必須   |

---

## 3. 非機能要件 (Non-Functional Requirements)

### 3.1 パフォーマンス

| ID     | 要件         | 目標値                                    |
| ------ | ------------ | ----------------------------------------- |
| NFR-01 | 起動時間     | 1 秒以内                                  |
| NFR-02 | ファイル配信 | 100MB 以下のファイルを 1 秒以内に配信開始 |
| NFR-03 | 同時接続     | 100 接続以上をエラーなく処理              |

### 3.2 信頼性

| ID     | 要件               | 説明                                           |
| ------ | ------------------ | ---------------------------------------------- |
| NFR-04 | エラーハンドリング | 不正なリクエストに適切な HTTP ステータスを返却 |
| NFR-05 | ファイル不在       | 404 Not Found を返却                           |
| NFR-06 | アクセス権限エラー | 403 Forbidden を返却                           |

### 3.3 セキュリティ

| ID     | 要件                 | 説明                                |
| ------ | -------------------- | ----------------------------------- |
| NFR-07 | パストラバーサル防止 | `../` などによる不正アクセスを防止  |
| NFR-08 | ローカルのみ         | デフォルトで`127.0.0.1`のみリッスン |

---

## 4. 技術設計

### 4.1 アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                  Development Tools (Tauri)              │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────────────────────────┐ │
│  │   Leptos    │    │         Mock Server             │ │
│  │     UI      │◄──►│  (Axum サイドカーサービス)       │ │
│  │             │    │                                 │ │
│  │ - 設定画面   │    │  - 静的ファイル配信              │ │
│  │ - ログ表示   │    │  - CORS処理                     │ │
│  │ - 状態表示   │    │  - アクセスログ送信              │ │
│  └─────────────┘    └─────────────────────────────────┘ │
│          │                       │                      │
│          ▼                       ▼                      │
│  ┌─────────────────────────────────────────────────────┐│
│  │              SQLite Database                        ││
│  │  - mock_server_config (ポート、CORS設定)             ││
│  │  - mock_server_mappings (仮想パスマッピング)         ││
│  └─────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────┘
```

### 4.2 技術スタック

| コンポーネント   | 技術                 | 選定理由                            |
| ---------------- | -------------------- | ----------------------------------- |
| サーバー         | Axum                 | Tokio ベース、高速、tower-http 連携 |
| 非同期ランタイム | Tokio                | Rust の非同期処理デファクト         |
| 静的配信         | tower-http ServeDir  | ゼロコピー転送、Range 対応          |
| CORS             | tower-http CorsLayer | 柔軟な CORS 設定                    |
| データベース     | SQLite (既存)        | Development Tools の既存 DB を活用  |
| UI               | Leptos (既存)        | Development Tools の既存 UI を活用  |

### 4.3 データベーススキーマ

```sql
-- サーバー設定
CREATE TABLE mock_server_config (
    id INTEGER PRIMARY KEY DEFAULT 1,
    port INTEGER NOT NULL DEFAULT 9876,
    cors_mode TEXT NOT NULL DEFAULT 'simple', -- 'simple' | 'advanced'
    cors_origins TEXT, -- JSON array for advanced mode
    cors_methods TEXT, -- JSON array for advanced mode
    cors_headers TEXT, -- JSON array for advanced mode
    cors_max_age INTEGER DEFAULT 86400,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ディレクトリマッピング
CREATE TABLE mock_server_mappings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    virtual_path TEXT NOT NULL UNIQUE,
    local_path TEXT NOT NULL,
    enabled INTEGER NOT NULL DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- アクセスログ（オプション：メモリのみでも可）
CREATE TABLE mock_server_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    method TEXT NOT NULL,
    path TEXT NOT NULL,
    status_code INTEGER NOT NULL,
    response_size INTEGER,
    response_time_ms INTEGER
);
```

---

## 5. UI 設計

### 5.1 サイドバー

サイドバーに「Mock Server」メニュー項目を追加：

```
┌──────────────────┐
│  🏠 Home         │
│  🔧 Tools        │
│  ─────────────── │
│  📡 Mock Server  │  ← 新規追加
│  ─────────────── │
│  ⚙️  Settings    │
└──────────────────┘
```

### 5.2 Mock Server ページ構成

```
┌─────────────────────────────────────────────────────────────────┐
│  Mock Server                                    [▶️ Start]      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Server Status                                            │   │
│  │ ● Stopped                    Port: [9876    ]            │   │
│  │ URL: http://localhost:9876                               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Directory Mappings                          [+ Add]      │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ /images     →  ~/Pictures/mock/          [📁] [🗑️]      │   │
│  │ /api        →  ~/projects/api-mock/      [📁] [🗑️]      │   │
│  │ /assets     →  /var/www/static/          [📁] [🗑️]      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ CORS Settings                    [Simple ▼]              │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ ✅ Allow all origins (*)                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Access Logs                                 [Clear]      │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 10:23:45  GET  /images/logo.png      200   45.2KB  12ms │   │
│  │ 10:23:44  GET  /api/users.json       200    1.2KB   3ms │   │
│  │ 10:23:42  GET  /assets/style.css     200    8.5KB   5ms │   │
│  │ 10:23:40  GET  /notfound.txt         404      -     2ms │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ File Browser                              [/images ▼]    │   │
│  ├─────────────────────────────────────────────────────────┤   │
│  │ 📁 icons/                                                │   │
│  │ 🖼️ logo.png                              245 KB          │   │
│  │ 🖼️ banner.jpg                            1.2 MB          │   │
│  │ 📄 data.json                              12 KB          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 CORS 詳細モード

```
┌─────────────────────────────────────────────────────────────┐
│ CORS Settings                         [Advanced ▼]          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Allowed Origins:                                            │
│ ┌─────────────────────────────────────────────────────────┐│
│ │ http://localhost:3000                              [x]  ││
│ │ http://localhost:5173                              [x]  ││
│ │ [+ Add Origin]                                          ││
│ └─────────────────────────────────────────────────────────┘│
│                                                             │
│ Allowed Methods:                                            │
│ [✅ GET] [✅ POST] [✅ PUT] [☐ DELETE] [☐ PATCH]            │
│                                                             │
│ Allowed Headers:                                            │
│ ┌─────────────────────────────────────────────────────────┐│
│ │ Content-Type                                       [x]  ││
│ │ Authorization                                      [x]  ││
│ │ [+ Add Header]                                          ││
│ └─────────────────────────────────────────────────────────┘│
│                                                             │
│ Max Age: [86400    ] seconds                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 実装計画

### Phase 1: コアサーバー実装（バックエンド）

| タスク | 説明                           | 見積もり |
| ------ | ------------------------------ | -------- |
| P1-01  | Axum サーバー基盤構築          | 2h       |
| P1-02  | 静的ファイル配信（ServeDir）   | 2h       |
| P1-03  | 複数ディレクトリマッピング対応 | 3h       |
| P1-04  | CORS 設定（簡易/詳細）         | 2h       |
| P1-05  | Range リクエスト対応           | 1h       |
| P1-06  | アクセスログ生成・イベント送信 | 2h       |

### Phase 2: Tauri コマンド実装

| タスク | 説明                      | 見積もり |
| ------ | ------------------------- | -------- |
| P2-01  | サーバー起動/停止コマンド | 2h       |
| P2-02  | 設定取得/更新コマンド     | 2h       |
| P2-03  | マッピング CRUD コマンド  | 2h       |
| P2-04  | ファイル一覧取得コマンド  | 1h       |
| P2-05  | ログイベントリスナー      | 1h       |

### Phase 3: データベース実装

| タスク | 説明                     | 見積もり |
| ------ | ------------------------ | -------- |
| P3-01  | スキーママイグレーション | 1h       |
| P3-02  | 設定 CRUD 関数           | 2h       |
| P3-03  | マッピング CRUD 関数     | 2h       |

### Phase 4: UI 実装（Leptos）

| タスク | 説明                      | 見積もり |
| ------ | ------------------------- | -------- |
| P4-01  | サイドバーメニュー追加    | 1h       |
| P4-02  | MockServer ページ基本構造 | 2h       |
| P4-03  | サーバー状態表示・制御    | 2h       |
| P4-04  | ディレクトリマッピング UI | 3h       |
| P4-05  | CORS 設定 UI              | 2h       |
| P4-06  | アクセスログ表示 UI       | 2h       |
| P4-07  | ファイルブラウザ UI       | 3h       |

### Phase 5: テスト・調整

| タスク | 説明               | 見積もり |
| ------ | ------------------ | -------- |
| P5-01  | 統合テスト         | 2h       |
| P5-02  | エッジケース対応   | 2h       |
| P5-03  | パフォーマンス確認 | 1h       |

**合計見積もり: 約 42 時間**

---

## 7. 将来の拡張（Phase 2 以降）

以下の機能は初回リリース後に検討：

| 機能                        | 説明                                     |
| --------------------------- | ---------------------------------------- |
| Gzip/Brotli 圧縮            | テキストファイルの転送最適化             |
| 設定エクスポート/インポート | 設定を JSON ファイルで共有               |
| API モック機能              | 固定 JSON レスポンスを返すエンドポイント |
| レイテンシシミュレーション  | 意図的な遅延を追加                       |
| HTTPS 対応                  | 自己署名証明書による暗号化通信           |
| 複数ポート同時起動          | 異なる設定で複数サーバーを起動           |

---

## 8. 用語集

| 用語          | 説明                                                            |
| ------------- | --------------------------------------------------------------- |
| 仮想パス      | URL のパス部分（例: `/images`）                                 |
| マッピング    | 仮想パスとローカルディレクトリの対応関係                        |
| サイドカー    | メインアプリと連携して動作する補助サービス                      |
| CORS          | Cross-Origin Resource Sharing（異なるオリジン間のリソース共有） |
| Range Request | ファイルの一部のみを取得する HTTP リクエスト                    |
